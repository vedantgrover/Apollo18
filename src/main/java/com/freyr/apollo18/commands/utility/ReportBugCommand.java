package com.freyr.apollo18.commands.utility;

import com.freyr.apollo18.Apollo18;
import com.freyr.apollo18.commands.Category;
import com.freyr.apollo18.commands.Command;
import com.freyr.apollo18.util.embeds.EmbedColor;
import net.dv8tion.jda.api.EmbedBuilder;
import net.dv8tion.jda.api.entities.MessageEmbed;
import net.dv8tion.jda.api.entities.channel.middleman.MessageChannel;
import net.dv8tion.jda.api.events.interaction.command.SlashCommandInteractionEvent;
import net.dv8tion.jda.api.interactions.commands.OptionMapping;
import net.dv8tion.jda.api.interactions.commands.OptionType;
import net.dv8tion.jda.api.interactions.commands.build.OptionData;

import java.time.Instant;

/**
 * This command allows you to report bugs that the user has found
 */
public class ReportBugCommand extends Command {

    public ReportBugCommand(Apollo18 bot) {
        super(bot);
        this.name = "report";
        this.description = "Report a bug!";
        this.category = Category.UTILITY;
        this.beingServiced = true;

        this.args.add(new OptionData(OptionType.STRING, "bug", "Please describe the bug you found", true));
        this.args.add(new OptionData(OptionType.ATTACHMENT, "example", "You can send in an image for us to look at.", false));
    }

    @Override
    public void execute(SlashCommandInteractionEvent event) {
        event.deferReply().queue();
        String bug = event.getOption("bug").getAsString();
        OptionMapping example = event.getOption("example");

        EmbedBuilder embed = new EmbedBuilder().setTitle("Bug Report!").setDescription("Bug Report Submitted by: " + event.getUser().getAsMention()).addField("Time", "<t:" + Instant.now().getEpochSecond() + ":F>", false).addField("Description", bug, false).setColor(EmbedColor.DEFAULT_COLOR);
        if (example != null) {
            embed.setImage(example.getAsAttachment().getUrl());
        }

        //noinspection ConstantConditions
        event.getGuild().getChannelById(MessageChannel.class, 854150278760103937L).sendMessageEmbeds(embed.build()).queue();

        MessageEmbed replyEmbed = new EmbedBuilder().setDescription(":white_check_mark: - **Your report has been sent to the bot developer!**").setColor(EmbedColor.DEFAULT_COLOR).build();
        event.getHook().sendMessageEmbeds(replyEmbed).setEphemeral(true).queue();
    }
}
